<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üßº Soap Smash - Lobby üïπÔ∏è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #7fD8E8; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; font-family: 'Arial', sans-serif; color: #333; text-align: center; }
        #host-ui, #controller-ui { width: 90%; max-width: 600px; background: rgba(255,255,255,0.85); padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        h1 { color: #FFA500; margin-top: 0; }
        h2 { margin-top: 20px; margin-bottom: 10px; }
        ul { list-style: none; padding: 0; }
        li { background: #f0f0f0; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .status-dot { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .connected { background-color: #4CAF50; /* Green */ }
        .disconnected { background-color: #f44336; /* Red */ }
        .qr-section { display: flex; justify-content: space-around; margin-top: 15px; flex-wrap: wrap; }
        .qr-code-container { margin: 10px; padding: 10px; background: #fff; border-radius: 8px; }
        .qr-code-container p { margin: 0 0 5px 0; font-size: 0.9em; }
        button {
            padding: 15px 30px; font-size: 1.2em; background-color: #FFD700; border: 3px solid #FFA500;
            border-radius: 10px; cursor: pointer; margin-top: 20px; transition: background-color 0.2s;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        button:hover { background-color: #FFA500; }
        button:disabled { background-color: #ccc; border-color: #999; cursor: not-allowed; }
        #controller-ui h2 { font-size: 1.5em; }
        #controller-message { margin-top: 15px; font-size: 1.1em; }
    </style>
</head>
<body>

    <div id="host-ui" style="display: none;">
        <h1>üßº Soap Smash Lobby üßº</h1>
        <p>Player 1 (You - Keyboard) is automatically joined.</p>
        <p>Scan QR codes with phones to join as other players.</p>

        <h2>Connected Players (<span id="connected-count">1</span>/<span id="max-players">2</span>):</h2>
        <ul id="player-list"></ul>

        <div class="qr-section">
            <!-- QR Codes will be injected here -->
        </div>

        <button id="startGameButton" disabled>Start Game</button>
        <p id="start-game-error" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="controller-ui" style="display: none;">
        <h1>üì± Controller Mode üì±</h1>
        <h2 id="controller-player-id-text"></h2>
        <button id="joinButton">Tap to Join Game</button>
        <p id="controller-message"></p>
    </div>

<script>
// --- Configuration ---
const MAX_GAME_PLAYERS = 4; // Total players allowed in the game (P1 is host)
const MIN_PLAYERS_TO_START = 2; // Minimum players needed to enable start button

// --- Global Variables ---
let broadcastChannel;
let isHost = false;
let controllerPlayerIndex = -1; // 0 for P1 (host), 1 for P2, 2 for P3, etc.

let sounds = {};
let playersStatus = []; // For host to track connected players

// --- p5.js Functions ---
function preload() {
    soundFormats('wav'); // Ensure p5.sound attempts to load .wav files
    sounds.backgroundLoop = loadSound('background loop.wav', () => console.log("BG loop loaded"), err => console.error("Error loading BG:", err));
    sounds.click = loadSound('click.wav', () => console.log("Click loaded"), err => console.error("Error loading click:", err));
    sounds.connected = loadSound('connected.wav', () => console.log("Connected loaded"), err => console.error("Error loading connected:", err));
    sounds.gamestart = loadSound('gamestart.wav', () => console.log("Gamestart loaded"), err => console.error("Error loading gamestart:", err));
    // sounds.clickof = loadSound('clickof.wav'); // If needed later
    // sounds.wah = loadSound('wah.wav');
    // sounds.woh = loadSound('woh.wav');
}

function setup() {
    noCanvas(); // We're not using p5 drawing canvas for the lobby UI itself

    broadcastChannel = new BroadcastChannel('soap_smash_lobby_channel');
    broadcastChannel.onmessage = handleLobbyMessage;

    const urlParams = new URLSearchParams(window.location.search);
    const controllerIdParam = urlParams.get('controller'); // This will be player INDEX (1, 2, or 3 for P2,P3,P4)

    if (controllerIdParam !== null) {
        isHost = false;
        controllerPlayerIndex = parseInt(controllerIdParam);
        setupControllerUI();
    } else {
        isHost = true;
        controllerPlayerIndex = 0; // Host is always Player 1 (index 0)
        setupHostUI();
        if (sounds.backgroundLoop && sounds.backgroundLoop.isLoaded()) {
            sounds.backgroundLoop.loop();
            sounds.backgroundLoop.setVolume(0.3); // Adjust volume as needed
        }
    }
}

// --- Host Specific Functions ---
function setupHostUI() {
    document.getElementById('host-ui').style.display = 'block';
    document.getElementById('max-players').innerText = MAX_GAME_PLAYERS;

    playersStatus = [];
    for (let i = 0; i < MAX_GAME_PLAYERS; i++) {
        playersStatus.push({
            id: i, // Player index (0 to MAX_GAME_PLAYERS-1)
            name: `Player ${i + 1}`,
            connected: (i === 0), // Player 1 (host) is auto-connected
            type: (i === 0) ? 'Keyboard (Host)' : 'Phone'
        });
    }
    updatePlayerListUI();
    generateQRCodesForControllers();

    document.getElementById('startGameButton').addEventListener('click', () => {
        if (sounds.click) sounds.click.play();
        const connectedCount = playersStatus.filter(p => p.connected).length;
        if (connectedCount >= MIN_PLAYERS_TO_START) {
            if (sounds.gamestart) sounds.gamestart.play();
            console.log("Attempting to start game...");
            document.getElementById('host-ui').innerHTML = `<h1>Game Starting...</h1><p>All players get ready!</p>`;
            broadcastChannel.postMessage({ type: 'GAME_START_COMMAND' });
            // Here you would transition to the actual game screen/logic
            // For now, we just show a message.
        } else {
            document.getElementById('start-game-error').innerText = `Need at least ${MIN_PLAYERS_TO_START} players to start.`;
            // play sounds.wah or sounds.woh here if desired for error
        }
    });
    checkStartButtonState();
}

function generateQRCodesForControllers() {
    const qrSection = document.querySelector('#host-ui .qr-section');
    qrSection.innerHTML = ''; // Clear previous
    const baseHref = window.location.href.split('?')[0];

    for (let i = 1; i < MAX_GAME_PLAYERS; i++) { // Start from i=1 for P2, P3, P4
        const controllerUrl = `${baseHref}?controller=${i}`;
        const container = document.createElement('div');
        container.className = 'qr-code-container';
        const p = document.createElement('p');
        p.innerText = `Player ${i + 1} Scan:`;
        const qrDiv = document.createElement('div');
        qrDiv.id = `qr-player-${i}`;
        container.appendChild(p);
        container.appendChild(qrDiv);
        qrSection.appendChild(container);
        new QRCode(qrDiv, { text: controllerUrl, width: 100, height: 100 });
    }
}

function updatePlayerListUI() {
    if (!isHost) return;
    const playerListElement = document.getElementById('player-list');
    playerListElement.innerHTML = ''; // Clear old list

    playersStatus.forEach(player => {
        const listItem = document.createElement('li');
        const statusDot = document.createElement('span');
        statusDot.className = 'status-dot ' + (player.connected ? 'connected' : 'disconnected');

        let nameText = `${player.name} (${player.type})`;
        if(player.id === 0) nameText = `Player 1 (Host - Keyboard)`;

        listItem.appendChild(statusDot);
        listItem.appendChild(document.createTextNode(nameText));
        playerListElement.appendChild(listItem);
    });

    const connectedCount = playersStatus.filter(p => p.connected).length;
    document.getElementById('connected-count').innerText = connectedCount;
    checkStartButtonState();
}

function checkStartButtonState() {
    if (!isHost) return;
    const connectedCount = playersStatus.filter(p => p.connected).length;
    const startGameButton = document.getElementById('startGameButton');
    if (connectedCount >= MIN_PLAYERS_TO_START) {
        startGameButton.disabled = false;
        document.getElementById('start-game-error').innerText = '';
    } else {
        startGameButton.disabled = true;
        document.getElementById('start-game-error').innerText = `Need ${MIN_PLAYERS_TO_START - connectedCount} more player(s).`;
    }
}

function setupControllerUI() {
    document.getElementById('controller-ui').style.display = 'flex';
    document.getElementById('controller-ui').style.flexDirection = 'column';
    document.getElementById('controller-player-id-text').innerText = `You are Player ${controllerPlayerIndex + 1}`;
    const joinButton = document.getElementById('joinButton');
    const controllerMessage = document.getElementById('controller-message');

    joinButton.addEventListener('click', () => {
        if (sounds.click) sounds.click.play();
        broadcastChannel.postMessage({
            type: 'JOIN_REQUEST',
            playerIndex: controllerPlayerIndex
        });
        joinButton.disabled = true;
        joinButton.innerText = 'Connecting...';
        controllerMessage.innerText = 'Attempting to connect to host...';
    });
}

function handleLobbyMessage(event) {
    const { type, playerIndex, data } = event.data;

    if (isHost) { // Messages received by the Host
        if (type === 'JOIN_REQUEST') {
            if (playerIndex >= 0 && playerIndex < MAX_GAME_PLAYERS) {
                if (!playersStatus[playerIndex].connected) {
                    playersStatus[playerIndex].connected = true;
                    if (sounds.connected) sounds.connected.play();
                    updatePlayerListUI();
                    // Send acknowledgment back to controller
                    broadcastChannel.postMessage({ type: 'JOIN_ACKNOWLEDGED', forPlayerIndex: playerIndex, success: true, playerName: playersStatus[playerIndex].name });
                } else {
                    // Player slot already taken or re-joining, could send a specific ack
                     broadcastChannel.postMessage({ type: 'JOIN_ACKNOWLEDGED', forPlayerIndex: playerIndex, success: false, reason: "Slot already active or re-join." });
                }
            }
        }
    } else { // Messages received by a Controller
        if (type === 'JOIN_ACKNOWLEDGED' && playerIndex === controllerPlayerIndex) {
            const controllerMessageEl = document.getElementById('controller-message');
            const joinButton = document.getElementById('joinButton');
            if (data.success) {
                controllerMessageEl.innerText = `Successfully connected as ${data.playerName}! Waiting for game to start.`;
                joinButton.innerText = 'Joined!';
                joinButton.disabled = true;
                if (sounds.connected) sounds.connected.play(); // Controller can also play a success sound
            } else {
                controllerMessageEl.innerText = `Connection failed: ${data.reason || 'Unknown error.'}`;
                joinButton.disabled = false; // Allow retry
                joinButton.innerText = 'Tap to Join Game';
            }
        } else if (type === 'GAME_START_COMMAND') {
            // Controller received command to start the game
            if (sounds.gamestart) sounds.gamestart.play(); // Optional for controller to also play
            document.getElementById('controller-ui').innerHTML = `<h1>Game Starting!</h1><p>Get Ready Player ${controllerPlayerIndex + 1}!</p><p>Your controls will appear here soon...</p>`;
            // Transition to game controls UI
        }
    }
}

window.onload = () => {

    if (typeof setup === 'function') {
      // new p5(); // This would create a default canvas if not handled, not needed here
    }
};

</script>
</body>
</html>